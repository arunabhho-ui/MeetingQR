<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Set Location – MAHE Attendance</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@400,0&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="../shared/leaflet.css" />
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Inter',sans-serif; background:#f5f5f5; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
    @media (min-width:768px) { body { flex-direction:row; } }
    .font-serif { font-family:'Playfair Display',serif; }
    #sidebar {
      width:100%; flex-shrink:0; background:#FFFCF7;
      border-right:1px solid #e8e1d4; display:flex; flex-direction:column;
      z-index:20; box-shadow:4px 0 16px rgba(0,0,0,0.08);
      max-height:55vh; overflow:hidden;
    }
    @media (min-width:768px) { #sidebar { width:360px; max-height:100vh; } }
    .sidebar-body { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
    #map { flex:1; height:45vh; }
    @media (min-width:768px) { #map { height:100vh; } }
    .mahe-input { width:100%; padding:10px 13px; border:1.5px solid #e0d8cc; border-radius:9px; background:#FDFAF6; font-size:14px; font-family:'Inter',sans-serif; outline:none; transition:all 0.2s; }
    .mahe-input:focus { border-color:#B67F3F; box-shadow:0 0 0 3px rgba(182,127,63,0.15); background:white; }
    .field-label { font-size:11px; font-weight:700; color:#6b7280; text-transform:uppercase; letter-spacing:0.07em; margin-bottom:7px; display:flex; align-items:center; gap:5px; }
    .mode-btn { flex:1; padding:9px 12px; font-size:13px; font-weight:600; border-radius:8px; border:none; cursor:pointer; transition:all 0.2s; font-family:'Inter',sans-serif; display:flex; align-items:center; justify-content:center; gap:6px; background:transparent; color:#6b7280; }
    .mode-btn.active { background:#B67F3F; color:white; box-shadow:0 2px 8px rgba(182,127,63,0.3); }
    input[type=range] { -webkit-appearance:none; width:100%; background:transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; height:20px; width:20px; border-radius:50%; background:#B67F3F; cursor:pointer; margin-top:-8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    input[type=range]::-webkit-slider-runnable-track { width:100%; height:4px; cursor:pointer; background:#e5e7eb; border-radius:2px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:7px; padding:11px 18px; border-radius:10px; font-weight:600; font-size:14px; cursor:pointer; transition:all 0.2s; border:none; font-family:'Inter',sans-serif; }
    .btn-gold { background:linear-gradient(135deg,#B67F3F,#8c5e26); color:white; box-shadow:0 4px 12px rgba(182,127,63,0.3); }
    .btn-gold:hover:not(:disabled) { transform:translateY(-1px); }
    .btn-green { background:#16a34a; color:white; }
    .btn-green:hover:not(:disabled) { background:#15803d; }
    .btn-outline { background:white; color:#B67F3F; border:1.5px solid #B67F3F; }
    .btn-outline:hover:not(:disabled) { background:#FDF6EC; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
  </style>
</head>
<body>

  <aside id="sidebar">
    <!-- Header -->
    <div style="padding:16px 20px;border-bottom:1px solid #e8e1d4;background:white;display:flex;align-items:center;gap:12px;flex-shrink:0">
      <img src="../logo.png" alt="MAHE" style="width:34px;height:34px;object-fit:contain" />
      <div>
        <div class="font-serif" style="font-weight:700;color:#1f2937;font-size:15px">Set Meeting Location</div>
        <div style="font-size:10px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.07em">MAHE Attendance System</div>
      </div>
    </div>

    <div class="sidebar-body">
      <a href="javascript:window.close()" style="display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:500;color:#B67F3F;text-decoration:none">
        <span class="material-symbols-outlined" style="font-size:16px">arrow_back</span>
        Back to Dashboard
      </a>

      <!-- Mode tabs – default: current location -->
      <div style="background:#f5ede0;padding:4px;border-radius:10px;display:flex;gap:4px">
        <button id="currentModeBtn" class="mode-btn active" onclick="switchMode('current')">
          <span class="material-symbols-outlined" style="font-size:16px">my_location</span>
          My Location
        </button>
        <button id="manualModeBtn" class="mode-btn" onclick="switchMode('manual')">
          <span class="material-symbols-outlined" style="font-size:16px">pin_drop</span>
          Manual Pin
        </button>
      </div>

      <!-- Current location mode (default, shown first) -->
      <div id="currentMode" style="display:flex;flex-direction:column;gap:10px">
        <div style="background:#f0fdf4;border-left:3px solid #16a34a;padding:10px 12px;border-radius:0 8px 8px 0">
          <p style="font-size:12px;color:#14532d;line-height:1.5">
            <strong>Current Location:</strong> Uses your device GPS as the meeting point. Tap below to capture your position.
          </p>
        </div>
        <button id="useCurrentBtn" onclick="useCurrentLocation()" class="btn btn-green" style="width:100%">
          <span class="material-symbols-outlined" style="font-size:16px">near_me</span>
          Set Current Location
        </button>
      </div>

      <!-- Manual mode (hidden by default) -->
      <div id="manualMode" style="display:none">
        <div style="background:#fefce8;border-left:3px solid #B67F3F;padding:10px 12px;border-radius:0 8px 8px 0">
          <p style="font-size:12px;color:#713f12;line-height:1.5">
            <strong>Manual:</strong> Click on the map to place the attendance pin, then set the radius.
          </p>
        </div>
      </div>

      <!-- Radius slider -->
      <div style="background:white;border:1px solid #e8e1d4;border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="field-label" style="margin-bottom:0">
            <span class="material-symbols-outlined" style="font-size:14px;color:#B67F3F">radar</span>
            Attendance Radius
          </div>
          <span id="radiusLabel" class="font-serif" style="font-size:20px;font-weight:700;color:#B67F3F">
            100 <span style="font-size:12px;color:#9ca3af;font-family:'Inter',sans-serif;font-weight:400">m</span>
          </span>
        </div>
        <input type="range" id="radius" min="10" max="500" value="100" oninput="updateRadiusPreview()" />
        <div style="display:flex;justify-content:space-between;font-size:11px;color:#9ca3af;font-weight:500">
          <span>10 m</span><span>250 m</span><span>500 m</span>
        </div>
        <p style="font-size:11px;color:#6b7280;background:#fdf8f3;padding:8px 10px;border-radius:6px;border:1px solid #eaddd5;line-height:1.5">
          <span style="font-weight:700;color:#B67F3F">Tip:</span> Larger radii help with poor GPS signals inside large halls.
        </p>
      </div>

      <!-- Preview -->
      <div id="previewSection" style="display:none;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:14px;flex-direction:column;gap:6px">
        <div style="display:flex;align-items:center;gap:6px;color:#15803d;font-size:12px;font-weight:700">
          <span class="material-symbols-outlined" style="font-size:16px">check_circle</span>
          Location Selected
        </div>
        <p id="previewText" style="font-size:12px;color:#166534;line-height:1.5"></p>
        <p id="distanceInfo" style="font-size:11px;color:#6b7280"></p>
      </div>
    </div>

    <!-- Confirm button -->
    <div style="padding:16px;background:white;border-top:1px solid #e8e1d4;flex-shrink:0">
      <button id="saveLocationBtn" onclick="saveLocation()" class="btn btn-gold" style="width:100%;display:none">
        <span class="material-symbols-outlined" style="font-size:16px">check_circle</span>
        Confirm Location
      </button>
      <p id="saveHint" style="text-align:center;font-size:12px;color:#9ca3af;margin-top:6px">
        Use "Set Current Location" or click the map to pick a point
      </p>
    </div>
  </aside>

  <main style="flex:1;position:relative">
    <div id="map"></div>
  </main>

  <script src="../shared/leaflet.js"></script>
  <script>
    // ── Inline toast for map page ──
    function mapToast(msg, type='success') {
      let c = document.getElementById('mapToastBox');
      if (!c) {
        c = document.createElement('div');
        c.id = 'mapToastBox';
        c.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:999;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none;';
        document.body.appendChild(c);
      }
      const colors = { success:{bg:'#f0fdf4',border:'#86efac',text:'#166534'}, error:{bg:'#fef2f2',border:'#fca5a5',text:'#991b1b'}, info:{bg:'#eff6ff',border:'#93c5fd',text:'#1e40af'} };
      const cl = colors[type] || colors.info;
      const t = document.createElement('div');
      t.style.cssText = `background:${cl.bg};border:1.5px solid ${cl.border};color:${cl.text};padding:10px 18px;border-radius:10px;font-size:13px;font-weight:600;font-family:'Inter',sans-serif;box-shadow:0 4px 12px rgba(0,0,0,0.1);transition:opacity 0.3s;`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000);
    }

    // Custom gold map marker from local asset
    const customIcon = L.icon({
      iconUrl: '../shared/map_marker.png',
      iconSize: [40, 56],
      iconAnchor: [20, 56],
      popupAnchor: [0, -58]
    });

    let map, marker, circle, selectedLocation = null, currentMode = 'current';

    map = L.map("map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors", maxZoom: 19
    }).addTo(map);

    // Default: try to center on user location immediately
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        p => map.setView([p.coords.latitude, p.coords.longitude], 18),
        () => map.setView([13.1251, 77.5899], 16),
        { enableHighAccuracy: true }
      );
    } else {
      map.setView([13.1251, 77.5899], 16);
    }

    function switchMode(mode) {
      currentMode = mode;
      document.getElementById('currentModeBtn').classList.toggle('active', mode === 'current');
      document.getElementById('manualModeBtn').classList.toggle('active', mode === 'manual');
      document.getElementById('currentMode').style.display = mode === 'current' ? 'flex' : 'none';
      document.getElementById('manualMode').style.display  = mode === 'manual'  ? 'block' : 'none';
      if (marker) map.removeLayer(marker);
      if (circle) map.removeLayer(circle);
      marker = circle = null; selectedLocation = null;
      document.getElementById('saveLocationBtn').style.display = 'none';
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('saveHint').style.display = 'block';
    }

    function updateRadiusPreview() {
      const r = Number(document.getElementById('radius').value);
      document.getElementById('radiusLabel').innerHTML = `${r} <span style="font-size:12px;color:#9ca3af;font-family:'Inter',sans-serif;font-weight:400">m</span>`;
      if (selectedLocation) updateCirclePreview();
    }

    function updateCirclePreview() {
      if (!selectedLocation) return;
      const radius = Number(document.getElementById('radius').value);
      if (circle) map.removeLayer(circle);
      const color = currentMode === 'manual' ? '#B67F3F' : '#16a34a';
      circle = L.circle([selectedLocation.lat, selectedLocation.lng], {
        radius, color, fillColor: color, fillOpacity: 0.15, weight: 2
      }).addTo(map);
      document.getElementById('previewSection').style.display = 'flex';
      document.getElementById('previewText').textContent = `Attendance zone: ${radius}m radius around selected point.`;
      document.getElementById('distanceInfo').textContent = `Coverage: ~${(Math.PI * radius * radius / 1e6).toFixed(4)} km²`;
      document.getElementById('saveLocationBtn').style.display = 'flex';
      document.getElementById('saveHint').style.display = 'none';
    }

    function useCurrentLocation() {
      const btn = document.getElementById('useCurrentBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px">refresh</span> Getting location...';
      navigator.geolocation.getCurrentPosition(pos => {
        selectedLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setView([selectedLocation.lat, selectedLocation.lng], 18);
        if (marker) map.removeLayer(marker);
        marker = L.marker([selectedLocation.lat, selectedLocation.lng], { icon: customIcon }).addTo(map);
        marker.bindPopup('Meeting Location').openPopup();
        updateCirclePreview();
        btn.disabled = false;
        btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px">check</span> Location Set!';
        setTimeout(() => {
          btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px">near_me</span> Set Current Location';
        }, 2000);
      }, () => {
        mapToast('Failed to get location. Check permissions.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px">near_me</span> Set Current Location';
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    // Manual map click
    map.on('click', e => {
      if (currentMode !== 'manual') return;
      selectedLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng, { icon: customIcon }).addTo(map);
      marker.bindPopup('Meeting Location').openPopup();
      updateCirclePreview();
    });

    function saveLocation() {
      if (!selectedLocation) { mapToast("Please select a location first", "error"); return; }
      const radius = Number(document.getElementById('radius').value);
      localStorage.setItem("locationConfig", JSON.stringify({
        latitude: selectedLocation.lat,
        longitude: selectedLocation.lng,
        radius
      }));
      mapToast("Location saved! Closing…", "success"); setTimeout(() => window.close(), 1200);
      window.close();
    }
  </script>
</body>
</html>
